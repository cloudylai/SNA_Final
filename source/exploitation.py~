import sys
import networkx as nx


def maxUserId(userL):
	max_user = -1;
	temp_list = []
	with open('Gowalla_new/link_prediction/users_info_new.dat', 'r') as f:
		for line in f:
			user = int(line.strip().split()[0])
			if user > max_user:
				max_user = user
			temp_list.append(user)
	print('max user id:', max_user)
	if userL != None:
		userL.extend(temp_list)
	return max_user


def maxSpotId(spotL):
	max_spot = -1;
	temp_list = []
	with open('Gowalla_new/link_prediction/spots_info.dat', 'r') as f:
		for line in f:
			spot = int(line.strip().split()[0])
			if spot > max_spot:
				max_spot = spot
			temp_list.append(spot)
	print('max spot id:', max_spot)
	if spotL != None:
		spotL.extend(temp_list)
	return max_spot




def mkUserGraph(G):
	with open('Gowalla_new/link_prediction/users_info_new.dat', 'r') as f:
		for line in f:
			user = int(line.strip().split()[0])
			G.add_node(user)
	with open('Gowalla_new/link_prediction/gowalla.train.txt', 'r') as f:
		for line in f:
			u1, u2, y = line.strip().split()
			u1 = int(u1)
			u2 = int(u2)
			y = int(y)
			if y == 1:
				G.add_edge(u1, u2)



# check dict: {user:{locations}}
def mkCheckPair(checkD):
	with open('Gowalla_new/link_prediction/checkins_info.dat', 'r') as f:
		for line in f:
			info = line.strip().split()
			user = int(info[0])
			checkD[user] = set()
			for check in info[1:]:
				pos = check.split(':')[-1]
				pos = int(pos)
				checkD[user].add(pos)




def exploitation():
	'''
	# show max user id #
	maxUserId(None)
	'''
	
	## MF approach ##
	# write check-in pair file #
	check_dict = dict()
	spot_list = list()
	user_list = list()
	test_user = set()
	mkCheckPair(check_dict)
	user_max = maxUserId(user_list)
	spot_max = maxSpotId(spot_list)
	'''
	with open('check_pair_tr.txt', 'w') as f:
		for u in check_dict:
			for l in check_dict[u]:
				print(u, l, 1, file=f)
			if spot_max not in check_dict[u]:
				print(u, spot_max, 0, file=f)
		if user_max not in check_dict and spot_max not in check_dict[user_max]:
			print(user_max, spot_max, 0, file=f)
	print('training check pair complete')
	'''
	# write test pair file #
	with open('Gowalla_new/link_prediction/gowalla.test.txt', 'r') as f:
		for line in f:
			u1, u2, s = line.strip().split()
			u1 = int(u1)
			u2 = int(u2)
			test_user.add(u1)
			test_user.add(u2)
	with open('check_pair_te.txt', 'w') as f:
		for u in user_list:
			for l in spot_list:
				if u not in check_dict or l not in check_dict[u]:
						print(u, l, 0, file=f)
	print('testing check pair complete')	

if __name__ == '__main__':
	exploitation()
